#!/bin/bash

# Signal aws cloud formation
# TODO: this is aws specific now and should be somewhere else
function send_signal {

echo "SENDING $1"
cfn-signal -e $1 \
--stack \
{{stack_name}}
{{keep_line}}
--resource \
{{resource_logical_name}}
{{keep_line}}
--region \
{{aws_region}}

}

type git || yum install -y git

git clone https://github.com/rapha-lima/DevOps.git /opt/DevOps

type salt-call || curl -sSL https://bootstrap.saltstack.com | sh
type unzip || yum install unzip -y

# Install aws bootstrap
echo "Installing wget"
yum install wget -y

echo "Fetching aws bootstrap"
wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz

echo "Unpackaging bootstrap"
tar xfv aws-cfn-bootstrap-latest.tar.gz && rm -f aws-cfn-bootstrap-latest.tar.gz

cd aws-cfn-bootstrap-*

echo "Installing bootstrap"
python setup.py install


if ! type aws >> /dev/null ; then
  echo "There is no AWS Cli packaged installed. Let's install it."
  wget --quiet https://s3.amazonaws.com/aws-cli/awscli-bundle.zip -O /tmp/awscli-bundle.zip && unzip -qo /tmp/awscli-bundle.zip -d /tmp/ && /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/bin/aws
fi

for i in /srv/salt /srv/pillar; do
  [[ -d $i ]] || mkdir -p $i
done

mountpoint -q /srv/salt || mount -B /opt/DevOps/salt /srv/salt
mountpoint -q /srv/pillar || mount -B /opt/DevOps/pillar /srv/pillar

rds_endpoint=$(aws rds describe-db-instances --db-instance-identifier DB-WordPress --region sa-east-1 | grep "Address" | cut -d '"' -f 4)

sed -i "s/rds_endpoint:/rds_endpoint: $rds_endpoint/" /srv/pillar/wordpress_rds.sls

echo "Running salt-call state.sls basic_install"
if ! salt-call --local state.sls masterless.wordpress; then
  send_signal 1
  exit 1
fi

instance-id=$(curl http://169.254.169.254/latest/meta-data/instance-id)



# Success
echo "SUCCESS"
send_signal 0
